---
- name: Invoke wire encryption for hdfs
  include_role:
    name: certs
  vars:
    component_prefix: hdfs
  become: yes
  become_user: root

- name: Invoke wire encryption for ranger plugins
  include_role:
    name: certs
  vars:
    component_prefix: ranger-hdfs-plugin
    certs_local_alias: "rangerHdfsAgent"
    certs_jks_file: ranger-plugin.jks
    certs_jks_req: ranger-plugin.req
    certs_jks_cert: ranger-plugin.crt
  become: yes
  become_user: root
  when: install_ranger == true

- name: Get ambari java home
  run_once: true
  local_action:
    module: set_fact
    java_home: '{{ "/etc/ambari-server/conf/ambari.properties" | get_ambari_java_home }}'

- name: set CA cert path and all hosts
  run_once: true
  local_action:
    module: set_fact
    java_ca_cert_path: "{{ java_home }}/jre/lib/security/cacerts"

- name: Add HDFS certs to ambari trusstore
  delegate_to: localhost
  run_once: true
  command: >
    keytool -import
    -file "{{ certs_dir }}/ca.crt"
    -keystore "{{ java_ca_cert_path }}"
    -alias hdfs
    -storepass "{{ java_jks_store_password }}"
    -noprompt